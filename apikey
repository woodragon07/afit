GOOGLE_API_KEY = "AIzaSyAFtCtB_ZfuRKTF8NiNP5lz-5C3WNVuGUk"
NAVER_CLIENT_ID = 'sVLg7QDsZXmBjyWgunV5'
NAVER_CLIENT_SECRET = '9_KNpe6xDN'


import re
import urllib.parse
import requests
import datetime
from flask import Flask, render_template, request, jsonify
import google.generativeai as genai

# ====== ì„¤ì • ======
GOOGLE_API_KEY = "AIzaSyAFtCtB_ZfuRKTF8NiNP5lz-5C3WNVuGUk"
NAVER_CLIENT_ID = 'sVLg7QDsZXmBjyWgunV5'
NAVER_CLIENT_SECRET = '9_KNpe6xDN'

genai.configure(api_key=GOOGLE_API_KEY)

app = Flask(__name__)

def clean_html(text):
    return re.sub('<.*?>', '', text)

def analyze_user_intent(user_input):
    """ì‚¬ìš©ì ì…ë ¥ì˜ ì˜ë„ë¥¼ ë¶„ì„"""
    model = genai.GenerativeModel("gemini-pro")
    prompt = f"""
    ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‚´ìš©: '{user_input}'
    
    ìš”ì²­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
    ì˜ë„ (ì¶”ì²œ/ê²€ìƒ‰/ê¸°íƒ€):
    ì¹´í…Œê³ ë¦¬ (ì œí’ˆ ì¢…ë¥˜):
    ê°€ê²©ëŒ€ (ìµœì†Œ ë° ìµœëŒ€):
    """
    try:
        response = model.generate_content(prompt)
        return eval(response.text.strip())
    except Exception as e:
        print(f"ì˜ë„ ë¶„ì„ ì˜¤ë¥˜: {e}")
        return {
            "intent": "ê²€ìƒ‰",
            "category": "",
            "price_range": None,
            "search_keywords": [user_input],
            "context": ""
        }

def extract_price_range(text):
    """ê°€ê²©ëŒ€ ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)"""
    try:
        match = re.search(r'(\d+)ë§Œì›ëŒ€', text)
        if match:
            base = int(match.group(1)) * 10000
            return {"min": base, "max": base + 99999}
            
        match = re.search(r'(\d+)ë§Œì›\s*(ì´í•˜|ë¯¸ë§Œ)', text)
        if match:
            max_price = int(match.group(1)) * 10000
            return {"min": 0, "max": max_price}
            
        match = re.search(r'(\d+)ë§Œì›\s*(ì´ìƒ|ì´ˆê³¼)', text)
        if match:
            min_price = int(match.group(1)) * 10000
            return {"min": min_price, "max": None}
            
        return None
    except Exception as e:
        print(f"ê°€ê²© ì¶”ì¶œ ì˜¤ë¥˜: {e}")
        return None

def search_naver_shopping(query, price_range=None):
    """ë„¤ì´ë²„ ì‡¼í•‘ ê²€ìƒ‰"""
    try:
        encoded_query = urllib.parse.quote(query)
        url = f"https://openapi.naver.com/v1/search/shop.json?query={encoded_query}&display=30&sort=asc"
        
        headers = {
            "X-Naver-Client-Id": NAVER_CLIENT_ID,
            "X-Naver-Client-Secret": NAVER_CLIENT_SECRET
        }
        
        response = requests.get(url, headers=headers)
        if response.status_code != 200:
            return []
            
        items = response.json().get("items", [])
        
        if price_range:
            filtered_items = []
            for item in items:
                price = int(item["lprice"])
                if price_range["min"] and price < price_range["min"]:
                    continue
                if price_range["max"] and price > price_range["max"]:
                    continue
                filtered_items.append(item)
            items = filtered_items

        items = sorted(items, key=lambda x: int(x["lprice"]))[:5]
        
        for item in items:
            item["title"] = clean_html(item["title"])
            
        return items
    except Exception as e:
        print(f"ì‡¼í•‘ ê²€ìƒ‰ ì˜¤ë¥˜: {e}")
        return []

def generate_shopping_advice(intent_data):
    """ì‡¼í•‘ ì¡°ì–¸ ìƒì„±"""
    model = genai.GenerativeModel("gemini-pro")
    prompt = f"""
    ì‡¼í•‘ ì¡°ì–¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”:
    ì¹´í…Œê³ ë¦¬: {intent_data["category"]}
    ê°€ê²©ëŒ€: {intent_data["price_range"]}
    ìƒí™©: {intent_data["context"]}
    
    ì¶”ì²œ ê¸°ì¤€:
    1. ì˜ˆì‚° ê³ ë ¤
    2. ì œí’ˆì˜ í’ˆì§ˆ, ê¸°ëŠ¥ ë“±
    3. ì‹¤ìš©ì„± ìˆëŠ” ì œí’ˆ ì¶”ì²œ
    """
    try:
        response = model.generate_content(prompt)
        return response.text.strip()
    except Exception as e:
        print(f"ì¡°ì–¸ ìƒì„± ì˜¤ë¥˜: {e}")
        return "ì œí’ˆì„ ì°¾ì•„ë³´ì•˜ìŠµë‹ˆë‹¤! ğŸ˜Š"

@app.route("/chat", methods=["POST"])
def chat():
    try:
        data = request.json
        user_message = data.get("message", "").strip()

        if not user_message:
            return jsonify({"error": "ë©”ì‹œì§€ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}), 400

        # ì‚¬ìš©ì ì˜ë„ ë¶„ì„
        intent_data = analyze_user_intent(user_message)
        
        # ê°€ê²©ëŒ€ ì •ë³´ ì¶”ì¶œ
        price_range = intent_data.get("price_range")
        if not price_range:
            price_range = extract_price_range(user_message)

        responses = []
        
        # ì‡¼í•‘ ì¡°ì–¸ ìƒì„±
        shopping_advice = generate_shopping_advice(intent_data)
        responses.append({"response": shopping_advice})

        # ê° í‚¤ì›Œë“œë¡œ ê²€ìƒ‰ ì‹¤í–‰
        found_items = False
        for keyword in intent_data["search_keywords"]:
            items = search_naver_shopping(keyword, price_range)
            if items:
                found_items = True
                for item in items:
                    product_html = f"""
                    <div class="product-card">
                        <img src="{item['image']}" alt="{item['title']}" />
                        <p class="product-title">{item['title']}</p>
                        <p class="product-price">{int(item['lprice']):,}ì›</p>
                        <a href="{item['link']}" target="_blank" class="product-link">
                            ì œí’ˆ ë³´ê¸°
                        </a>
                    </div>
                    """
                    responses.append({"response": product_html, "html": True})

        if not found_items:
            responses.append({
                "response": "ğŸ˜… ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ì œí’ˆì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ ê°€ê²©ëŒ€ëŠ” ì–´ë– ì„¸ìš”?"
            })

        return jsonify(responses), 200

    except Exception as e:
        print(f"ì±„íŒ… ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
        return jsonify([{
            "response": "ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
        }]), 500

@app.route("/", methods=["GET"])
def index():
    now = datetime.datetime.now()
    return render_template("search.html", now=now)

if __name__ == "__main__":
    app.run(debug=True, port=5000)
